{"is_source_file": true, "format": "Python", "description": "This Python source file implements a chat assistant service that interacts with OpenAI's chat API. It manages message history, constructs API requests, handles responses, and provides fallback responses when external API calls fail. It includes configurations, message processing, and deterministic reply heuristics for robustness and testing.", "external_files": ["src.api.schemas", "src.config"], "external_methods": ["src.api.schemas.Message", "src.api.schemas.RoleEnum", "src.config.settings"], "published": ["generate_reply", "summarize_prompt"], "classes": [], "methods": [{"name": "bool _openai_is_configured()", "description": "Checks if the OpenAI API is configured via environment settings.", "scope": "", "scopeKind": ""}, {"name": "Optional[str] _extract_last_user_message(messages: List[Message])", "description": "Retrieves the most recent user message content from message history.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _build_messages_for_openai(messages: List[Message], response_style: Optional[str])", "description": "Constructs the message list to send to OpenAI, including system prompts based on response style.", "scope": "", "scopeKind": ""}, {"name": "dict _build_openai_payload(messages: List[Message], response_style: Optional[str])", "description": "Builds the request payload for the OpenAI API with parameters and message history.", "scope": "", "scopeKind": ""}, {"name": "Optional[str] _call_openai(messages: List[Message], response_style: Optional[str])", "description": "Makes an API call to OpenAI's chat endpoint and returns the reply, handling errors gracefully.", "scope": "", "scopeKind": ""}, {"name": "str _deterministic_fallback_reply(messages: List[Message], response_style: Optional[str])", "description": "Provides heuristic-based fallback responses when API calls fail, detecting patterns like requests for examples or vegetables.", "scope": "", "scopeKind": ""}, {"name": "str generate_reply(messages: List[Message], response_style: Optional[str] = None)", "description": "Main interface to generate a chat reply, using OpenAI API when possible, otherwise falls back to heuristic responses.", "scope": "", "scopeKind": ""}, {"name": "str summarize_prompt(prompt: str)", "description": "Creates a brief, deterministic summary or hint based on the user's prompt.", "scope": "", "scopeKind": ""}], "calls": ["_openai_is_configured", "_build_openai_payload", "_call_openai", "_deterministic_fallback_reply"], "search-terms": ["chat API", "fallback heuristic", "message history", "OpenAI chat completion", "response style", "deterministic reply", "list-style responses", "prompt heuristics", "api request construction"], "state": 2, "file_id": 6, "knowledge_revision": 58, "git_revision": "6c70cf123600356025f5691450d9d9b7fccf0ee9", "revision_history": [{"13": "e27cab233c6df5353338e43a779cb65c198264eb"}, {"15": "e27cab233c6df5353338e43a779cb65c198264eb"}, {"34": "e27cab233c6df5353338e43a779cb65c198264eb"}, {"48": "abaa71d265cdf42d7c76a31c44f2c80d59ea2967"}, {"53": "cab4e039bd7312c8402178b1e7ba5a1cf262cdf1"}, {"56": "6c70cf123600356025f5691450d9d9b7fccf0ee9"}, {"57": "6c70cf123600356025f5691450d9d9b7fccf0ee9"}, {"58": "6c70cf123600356025f5691450d9d9b7fccf0ee9"}], "ctags": [{"_type": "tag", "name": "DEFAULT_GREETING", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^DEFAULT_GREETING = ($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MAX_INPUT_CHARS", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^MAX_INPUT_CHARS = 5000$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MAX_RESPONSE_CHARS", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^MAX_RESPONSE_CHARS = 4000$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "OPENAI_CHAT_URL", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^OPENAI_CHAT_URL = \"https:\\/\\/api.openai.com\\/v1\\/chat\\/completions\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "OPENAI_DEFAULT_MODEL", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^OPENAI_DEFAULT_MODEL = \"gpt-4o-mini\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SYSTEM_PROMPT_BASE", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^SYSTEM_PROMPT_BASE = ($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SYSTEM_PROMPT_GUIDED", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^SYSTEM_PROMPT_GUIDED = ($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "SYSTEM_PROMPT_LIST_HINT", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^SYSTEM_PROMPT_LIST_HINT = ($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_build_messages_for_openai", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _build_messages_for_openai(messages: List[Message], response_style: Optional[str]) -> List[d/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(messages: List[Message], response_style: Optional[str])"}, {"_type": "tag", "name": "_build_openai_payload", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _build_openai_payload(messages: List[Message], response_style: Optional[str]) -> dict:$/", "language": "Python", "typeref": "typename:dict", "kind": "function", "signature": "(messages: List[Message], response_style: Optional[str])"}, {"_type": "tag", "name": "_call_openai", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _call_openai(messages: List[Message], response_style: Optional[str]) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(messages: List[Message], response_style: Optional[str])"}, {"_type": "tag", "name": "_deterministic_fallback_reply", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _deterministic_fallback_reply(messages: List[Message], response_style: Optional[str]) -> str/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(messages: List[Message], response_style: Optional[str])"}, {"_type": "tag", "name": "_extract_last_user_message", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _extract_last_user_message(messages: List[Message]) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(messages: List[Message])"}, {"_type": "tag", "name": "_openai_is_configured", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def _openai_is_configured() -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "generate_reply", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def generate_reply(messages: List[Message], response_style: Optional[str] = None) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(messages: List[Message], response_style: Optional[str] = None)"}, {"_type": "tag", "name": "summarize_prompt", "path": "/home/kavia/workspace/code-generation/ai-copilot-assistant-147080-147089/fastapi_backend/src/services/chat.py", "pattern": "/^def summarize_prompt(prompt: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(prompt: str)"}], "hash": "af547f96d5eb712f77d14e6c65bb4b98", "format-version": 4, "code-base-name": "fastapi_backend", "filename": "fastapi_backend/src/services/chat.py", "fields": [{"name": "DEFAULT_GREETING = (", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MAX_INPUT_CHARS = 5000", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "MAX_RESPONSE_CHARS = 4000", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "OPENAI_CHAT_URL = \"https:\\/\\/api.openai.com\\/v1\\/chat\\/completions\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "OPENAI_DEFAULT_MODEL = \"gpt-4o-mini\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SYSTEM_PROMPT_BASE = (", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SYSTEM_PROMPT_GUIDED = (", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "SYSTEM_PROMPT_LIST_HINT = (", "scope": "", "scopeKind": "", "description": "unavailable"}]}